name: User Management Script CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * *" # Daily security scan at 2 AM

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          check_together: true
          severity: all
          format: gcc

      - name: Run security scan
        run: |
          # Check for hardcoded secrets
          if grep -r -i "password\|secret\|key\|token" --include="*.sh" . | grep -v "README\|config\|test"; then
            echo "Potential hardcoded secrets found"
            exit 1
          fi

      - name: Check file permissions
        run: |
          find . -name "*.sh" -exec chmod 755 {} \;
          find . -name "*.conf" -exec chmod 644 {} \;

  syntax-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check script syntax
        run: |
          bash -n user_manager.sh
          bash -n scripts/deploy.sh
          bash -n tests/test_script.sh

  functional-test:
    runs-on: ubuntu-latest
    needs: [security-scan, syntax-check]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run tests
        run: |
          sudo chmod +x tests/test_script.sh
          sudo ./tests/test_script.sh

  compliance-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check compliance files
        run: |
          # Ensure required compliance files exist
          test -f SECURITY.md || (echo "SECURITY.md missing" && exit 1)
          test -f LICENSE.md || (echo "LICENSE.md missing" && exit 1)
          test -f .gitignore || (echo ".gitignore missing" && exit 1)

      - name: Validate documentation
        run: |
          # Check README completeness
          grep -q "## Security" README.md || (echo "Security section missing in README" && exit 1)
          grep -q "## Installation" README.md || (echo "Installation section missing in README" && exit 1)

  deploy-staging:
    runs-on: ubuntu-latest
    needs: [functional-test, compliance-check]
    if: github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment"
          # Add staging deployment commands here

  deploy-production:
    runs-on: ubuntu-latest
    needs: [functional-test, compliance-check]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v5

      - name: Deploy to production
        run: |
          echo "Deploying to production environment"
          # Add production deployment commands here
